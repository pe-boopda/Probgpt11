import React, { useState, useEffect } from 'react';
import { AlertCircle, Plus, Trash2, Edit, Play, BookOpen, Clock, CheckCircle, XCircle, Save, LogOut, ArrowLeft, Send, BarChart3, TrendingUp, Award, Target } from 'lucide-react';

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login');
  const [tests, setTests] = useState([]);
  const [sessions, setSessions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({ title: '', description: '', timeLimit: 30, passingScore: 70, questions: [] });
  const [session, setSession] = useState(null);
  const [qIndex, setQIndex] = useState(0);
  const [answers, setAnswers] = useState({});
  const [time, setTime] = useState(null);
  const [statsTestId, setStatsTestId] = useState(null);

  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        try { const r = await window.storage.get('tests'); if (r?.value) setTests(JSON.parse(r.value)); } catch (e) { setTests([]); }
        try { const r = await window.storage.get('sessions'); if (r?.value) setSessions(JSON.parse(r.value)); } catch (e) { setSessions([]); }
      } finally { setLoading(false); }
    })();
  }, []);

  useEffect(() => {
    if (session && time > 0) {
      const t = setInterval(() => setTime(p => { if (p <= 1) { submit(); return 0; } return p - 1; }), 1000);
      return () => clearInterval(t);
    }
  }, [session, time]);

  const saveT = async (t) => { try { await window.storage.set('tests', JSON.stringify(t)); setTests(t); } catch (e) { setError('Ошибка'); } };
  const saveS = async (s) => { try { await window.storage.set('sessions', JSON.stringify(s)); setSessions(s); } catch (e) { setError('Ошибка'); } };

  const submit = async () => {
    if (!session) return;
    const test = tests.find(t => t.id === session.testId);
    let score = 0, max = 0;
    const qResults = [];
    
    test.questions.forEach(q => {
      max += q.points;
      const a = answers[q.id];
      let correct = false;
      
      if (q.type === 'multiple-choice' && a === q.correctAnswer) { score += q.points; correct = true; }
      else if (q.type === 'true-false' && a === q.correctAnswer) { score += q.points; correct = true; }
      else if (q.type === 'short-answer' && a && q.correctAnswer && a.toLowerCase().trim() === q.correctAnswer.toLowerCase().trim()) { score += q.points; correct = true; }
      else if (q.type === 'multiple-select' && JSON.stringify((q.correctAnswers || []).sort()) === JSON.stringify((a || []).sort())) { score += q.points; correct = true; }
      
      qResults.push({ questionId: q.id, correct, userAnswer: a });
    });
    
    const pct = max > 0 ? Math.round((score / max) * 100) : 0;
    const s = { 
      ...session, 
      answers, 
      score, 
      maxScore: max, 
      percentage: pct, 
      passed: pct >= test.passingScore, 
      completedAt: new Date().toISOString(), 
      status: 'completed',
      questionResults: qResults,
      timeSpent: (test.timeLimit * 60) - time
    };
    await saveS([...sessions, s]);
    setSession(s);
    setView('results');
  };

  const getStats = (tid) => {
    const ss = sessions.filter(s => s.testId === tid && s.status === 'completed');
    if (!ss.length) return null;
    const scores = ss.map(s => s.percentage);
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    const passed = ss.filter(s => s.passed).length;
    const avgTime = ss.reduce((sum, s) => sum + (s.timeSpent || 0), 0) / ss.length;
    return {
      total: ss.length,
      avg: Math.round(avg),
      passRate: Math.round((passed / ss.length) * 100),
      high: Math.max(...scores),
      low: Math.min(...scores),
      avgTime: Math.round(avgTime),
      trend: ss.slice(-5).map(s => s.percentage),
      recent: ss.slice(-5).reverse()
    };
  };

  const getQStats = (tid) => {
    const test = tests.find(t => t.id === tid);
    if (!test) return [];
    const ss = sessions.filter(s => s.testId === tid && s.status === 'completed' && s.questionResults);
    if (!ss.length) return [];
    return test.questions.map(q => {
      const results = ss.map(s => s.questionResults?.find(qr => qr.questionId === q.id));
      const correct = results.filter(r => r?.correct).length;
      const total = results.length;
      const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
      return {
        question: q,
        rate,
        total,
        correct,
        difficulty: rate > 70 ? 'Легкий' : rate > 40 ? 'Средний' : 'Сложный'
      };
    });
  };

  const Bar = ({ val, max = 100, color = 'indigo' }) => {
    const pct = Math.min((val / max) * 100, 100);
    const colors = { indigo: 'bg-indigo-600', green: 'bg-green-600', red: 'bg-red-600', yellow: 'bg-yellow-600', blue: 'bg-blue-600' };
    return <div className="w-full bg-gray-200 rounded-full h-2"><div className={colors[color] + ' h-2 rounded-full transition-all'} style={{ width: pct + '%' }}></div></div>;
  };

  const Chart = ({ data }) => {
    if (!data || !data.length) return null;
    const max = Math.max(...data);
    const min = Math.min(...data);
    const range = max - min || 1;
    return (
      <div className="flex items-end gap-1 h-12">
        {data.map((v, i) => {
          const h = ((v - min) / range) * 100;
          return <div key={i} className="flex-1 bg-indigo-600 rounded-t" style={{ height: h + '%', minHeight: '4px' }}></div>;
        })}
      </div>
    );
  };

  if (loading) return <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center"><div className="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div></div>;

  if (view === 'login') return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <div className="text-center mb-8"><BookOpen className="w-16 h-16 text-indigo-600 mx-auto mb-4" /><h1 className="text-3xl font-bold mb-2">Система тестирования</h1></div>
        <div className="space-y-4">
          <button onClick={() => { setUser({ role: 'admin', name: 'Администратор', id: Date.now() }); setView('admin'); }} className="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 font-semibold">Администратор</button>
          <button onClick={() => { setUser({ role: 'student', name: 'Студент', id: Date.now() }); setView('student'); }} className="w-full bg-green-600 text-white py-4 rounded-lg hover:bg-green-700 font-semibold">Студент</button>
        </div>
      </div>
    </div>
  );

  if (view === 'admin') return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between"><div><h1 className="text-xl font-bold">Панель администратора</h1></div><button onClick={() => { setUser(null); setView('login'); }} className="flex items-center gap-2 text-gray-600"><LogOut className="w-5 h-5" />Выход</button></div>
      </nav>
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="flex justify-between mb-6">
          <h2 className="text-2xl font-bold">Мои тесты</h2>
          <button onClick={() => { setEditing(null); setForm({ title: '', description: '', timeLimit: 30, passingScore: 70, questions: [] }); setView('editor'); }} className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 flex items-center gap-2"><Plus className="w-5 h-5" />Создать</button>
        </div>
        {tests.length === 0 ? <div className="bg-white rounded-lg shadow p-12 text-center"><BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" /><p className="text-gray-500">Нет тестов</p></div> : (
          <div className="space-y-4">
            {tests.map(t => {
              const st = getStats(t.id);
              return (
                <div key={t.id} className="bg-white rounded-lg shadow p-6">
                  <div className="flex justify-between mb-4">
                    <div className="flex-1"><h3 className="text-xl font-bold mb-2">{t.title}</h3><p className="text-gray-600 mb-3">{t.description}</p><div className="flex gap-4 text-sm text-gray-500"><span>{t.questions.length} вопросов</span><span>{t.timeLimit} мин</span></div></div>
                    <div className="flex gap-2">
                      {st && <button onClick={() => { setStatsTestId(t.id); setView('stats'); }} className="p-2 text-green-600 hover:bg-green-50 rounded"><BarChart3 className="w-5 h-5" /></button>}
                      <button onClick={() => { setEditing(t); setForm(t); setView('editor'); }} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><Edit className="w-5 h-5" /></button>
                      <button onClick={async () => { if (window.confirm('Удалить?')) await saveT(tests.filter(x => x.id !== t.id)); }} className="p-2 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-5 h-5" /></button>
                    </div>
                  </div>
                  {st && (
                    <div className="pt-4 border-t">
                      <div className="grid grid-cols-5 gap-4 mb-4">
                        <div className="text-center"><div className="text-2xl font-bold text-indigo-600">{st.total}</div><div className="text-xs text-gray-500">Попыток</div></div>
                        <div className="text-center"><div className="text-2xl font-bold text-green-600">{st.avg}%</div><div className="text-xs text-gray-500">Средний</div></div>
                        <div className="text-center"><div className="text-2xl font-bold text-blue-600">{st.passRate}%</div><div className="text-xs text-gray-500">Прошли</div></div>
                        <div className="text-center"><div className="text-2xl font-bold text-purple-600">{st.high}%</div><div className="text-xs text-gray-500">Лучший</div></div>
                        <div className="text-center"><div className="text-2xl font-bold text-orange-600">{Math.floor(st.avgTime / 60)}м</div><div className="text-xs text-gray-500">Время</div></div>
                      </div>
                      {st.trend.length > 0 && <div><div className="text-xs text-gray-500 mb-2">Тренд</div><Chart data={st.trend} /></div>}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );

  if (view === 'stats') {
    const test = tests.find(t => t.id === statsTestId);
    const st = getStats(statsTestId);
    const qs = getQStats(statsTestId);
    return (
      <div className="min-h-screen bg-gray-50">
        <nav className="bg-white shadow-sm border-b"><div className="max-w-7xl mx-auto px-4 py-4 flex justify-between"><button onClick={() => setView('admin')} className="flex items-center gap-2 text-gray-600"><ArrowLeft className="w-5 h-5" />Назад</button><h1 className="text-xl font-bold">Статистика: {test?.title}</h1><div></div></div></nav>
        <div className="max-w-7xl mx-auto px-4 py-8">
          <div className="grid md:grid-cols-4 gap-6 mb-8">
            <div className="bg-white rounded-lg shadow p-6"><div className="flex items-center gap-3"><Target className="w-8 h-8 text-indigo-600" /><div><div className="text-2xl font-bold">{st.total}</div><div className="text-sm text-gray-500">Попыток</div></div></div></div>
            <div className="bg-white rounded-lg shadow p-6"><div className="flex items-center gap-3 mb-2"><TrendingUp className="w-8 h-8 text-green-600" /><div><div className="text-2xl font-bold">{st.avg}%</div><div className="text-sm text-gray-500">Средний</div></div></div><Bar val={st.avg} color="green" /></div>
            <div className="bg-white rounded-lg shadow p-6"><div className="flex items-center gap-3 mb-2"><CheckCircle className="w-8 h-8 text-blue-600" /><div><div className="text-2xl font-bold">{st.passRate}%</div><div className="text-sm text-gray-500">Сдача</div></div></div><Bar val={st.passRate} color="blue" /></div>
            <div className="bg-white rounded-lg shadow p-6"><div className="flex items-center gap-3"><Award className="w-8 h-8 text-yellow-600" /><div><div className="text-2xl font-bold">{st.high}%</div><div className="text-sm text-gray-500">Лучший</div></div></div></div>
          </div>
          <div className="bg-white rounded-lg shadow p-6 mb-8">
            <h2 className="text-lg font-bold mb-4">Тренд результатов</h2>
            {st.trend.length > 0 ? (
              <div className="h-32"><div className="flex items-end justify-between h-full gap-2">{st.trend.map((s, i) => <div key={i} className="flex-1 flex flex-col items-center"><div className="text-xs font-semibold mb-1">{s}%</div><div className="w-full bg-indigo-600 rounded-t" style={{ height: s + '%' }}></div></div>)}</div></div>
            ) : <p className="text-gray-500 text-center py-8">Недостаточно данных</p>}
          </div>
          <div className="bg-white rounded-lg shadow p-6 mb-8">
            <h2 className="text-lg font-bold mb-4">Анализ вопросов</h2>
            {qs.length > 0 ? (
              <div className="space-y-4">
                {qs.map((q, i) => (
                  <div key={i} className="border rounded-lg p-4">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1"><div className="font-semibold mb-1">Вопрос {i + 1}</div><div className="text-sm text-gray-600">{q.question.text}</div></div>
                      <div className={'px-3 py-1 rounded-full text-xs font-semibold ' + (q.difficulty === 'Легкий' ? 'bg-green-100 text-green-800' : q.difficulty === 'Средний' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800')}>{q.difficulty}</div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="flex-1"><div className="flex justify-between text-xs text-gray-600 mb-1"><span>Правильных</span><span>{q.correct} / {q.total}</span></div><Bar val={q.rate} color={q.rate > 70 ? 'green' : q.rate > 40 ? 'yellow' : 'red'} /></div>
                      <div className="text-2xl font-bold text-indigo-600">{q.rate}%</div>
                    </div>
                  </div>
                ))}
              </div>
            ) : <p className="text-gray-500 text-center py-8">Нет данных</p>}
          </div>
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-lg font-bold mb-4">Последние попытки</h2>
            {st.recent.length > 0 ? (
              <div className="space-y-3">
                {st.recent.map((s, i) => (
                  <div key={i} className="flex items-center justify-between p-4 border rounded-lg">
                    <div className="flex items-center gap-3">{s.passed ? <CheckCircle className="w-6 h-6 text-green-600" /> : <XCircle className="w-6 h-6 text-red-600" />}<div><div className="font-semibold">{s.percentage}%</div><div className="text-xs text-gray-500">{new Date(s.completedAt).toLocaleString('ru')}</div></div></div>
                    <div className="text-sm text-gray-600">{s.score} / {s.maxScore} баллов</div>
                  </div>
                ))}
              </div>
            ) : <p className="text-gray-500 text-center py-8">Нет данных</p>}
          </div>
        </div>
      </div>
    );
  }

  if (view === 'editor') return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm border-b"><div className="max-w-7xl mx-auto px-4 py-4 flex justify-between"><button onClick={() => setView('admin')} className="flex items-center gap-2 text-gray-600"><ArrowLeft className="w-5 h-5" />Назад</button><button onClick={async () => { if (!form.title.trim()) { setError('Введите название'); return; } if (form.questions.length === 0) { setError('Добавьте вопросы'); return; } const t = { ...form, id: editing?.id || Date.now(), createdAt: editing?.createdAt || new Date().toISOString() }; await saveT(editing ? tests.map(x => x.id === editing.id ? t : x) : [...tests, t]); setView('admin'); setError(null); }} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"><Save className="w-5 h-5" />Сохранить</button></div></nav>
      <div className="max-w-4xl mx-auto px-4 py-8">
        {error && <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex gap-2"><AlertCircle className="w-5 h-5 text-red-600" /><p className="text-sm text-red-800">{error}</p></div>}
        <div className="bg-white rounded-lg shadow p-6 mb-6"><div className="space-y-4"><input type="text" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })} className="w-full px-4 py-2 border rounded-lg" placeholder="Название" /><textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full px-4 py-2 border rounded-lg" rows={3} placeholder="Описание" /><div className="grid grid-cols-2 gap-4"><input type="number" value={form.timeLimit} onChange={e => setForm({ ...form, timeLimit: parseInt(e.target.value) || 0 })} className="w-full px-4 py-2 border rounded-lg" placeholder="Время (мин)" min="1" /><input type="number" value={form.passingScore} onChange={e => setForm({ ...form, passingScore: parseInt(e.target.value) || 0 })} className="w-full px-4 py-2 border rounded-lg" placeholder="Проходной (%)" min="0" max="100" /></div></div></div>
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex justify-between mb-4"><h2 className="text-lg font-bold">Вопросы ({form.questions.length})</h2><button onClick={() => setForm({ ...form, questions: [...form.questions, { id: Date.now(), type: 'multiple-choice', text: '', options: ['', '', '', ''], correctAnswer: 0, points: 1 }] })} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"><Plus className="w-5 h-5" />Добавить</button></div>
          {form.questions.map((q, i) => (
            <div key={q.id} className="border rounded-lg p-4 mb-4">
              <div className="flex justify-between mb-4"><span className="font-semibold">Вопрос {i + 1}</span><button onClick={() => setForm({ ...form, questions: form.questions.filter((_, idx) => idx !== i) })} className="text-red-600"><Trash2 className="w-5 h-5" /></button></div>
              <div className="space-y-4">
                <select value={q.type} onChange={e => { const qs = [...form.questions]; qs[i] = { ...qs[i], type: e.target.value }; setForm({ ...form, questions: qs }); }} className="w-full px-4 py-2 border rounded-lg"><option value="multiple-choice">Один ответ</option><option value="true-false">Правда/Ложь</option><option value="short-answer">Короткий ответ</option></select>
                <textarea value={q.text} onChange={e => { const qs = [...form.questions]; qs[i] = { ...qs[i], text: e.target.value }; setForm({ ...form, questions: qs }); }} className="w-full px-4 py-2 border rounded-lg" rows={2} placeholder="Текст вопроса" />
                {q.type === 'multiple-choice' && q.options.map((o, j) => <div key={j} className="flex gap-2"><input type="radio" name={'q' + q.id} checked={q.correctAnswer === j} onChange={() => { const qs = [...form.questions]; qs[i] = { ...qs[i], correctAnswer: j }; setForm({ ...form, questions: qs }); }} className="mt-3" /><input type="text" value={o} onChange={e => { const qs = [...form.questions]; qs[i].options[j] = e.target.value; setForm({ ...form, questions: qs }); }} className="flex-1 px-4 py-2 border rounded-lg" placeholder={'Вариант ' + (j + 1)} /></div>)}
                {q.type === 'true-false' && <div className="flex gap-4"><label className="flex items-center"><input type="radio" checked={q.correctAnswer === true} onChange={() => { const qs = [...form.questions]; qs[i] = { ...qs[i], correctAnswer: true }; setForm({ ...form, questions: qs }); }} className="mr-2" />Правда</label><label className="flex items-center"><input type="radio" checked={q.correctAnswer === false} onChange={() => { const qs = [...form.questions]; qs[i] = { ...qs[i], correctAnswer: false }; setForm({ ...form, questions: qs }); }} className="mr-2" />Ложь</label></div>}
                {q.type === 'short-answer' && <input type="text" value={q.correctAnswer || ''} onChange={e => { const qs = [...form.questions]; qs[i] = { ...qs[i], correctAnswer: e.target.value }; setForm({ ...form, questions: qs }); }} className="w-full px-4 py-2 border rounded-lg" placeholder="Правильный ответ" />}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );

  if (view === 'student') return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm border-b"><div className="max-w-7xl mx-auto px-4 py-4 flex justify-between"><h1 className="text-xl font-bold">Доступные тесты</h1><button onClick={() => { setUser(null); setView('login'); }} className="flex items-center gap-2 text-gray-600"><LogOut className="w-5 h-5" />Выход</button></div></nav>
      <div className="max-w-7xl mx-auto px-4 py-8">
        {tests.length === 0 ? <div className="bg-white rounded-lg shadow p-12 text-center"><BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" /><p className="text-gray-500">Нет тестов</p></div> : (
          <div className="grid md:grid-cols-2 gap-6">
            {tests.map(t => {
              const us = sessions.filter(s => s.userId === user.id && s.testId === t.id && s.status === 'completed');
              const best = us.length > 0 ? Math.max(...us.map(s => s.percentage)) : null;
              return (
                <div key={t.id} className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-xl font-bold mb-2">{t.title}</h3>
                  <p className="text-gray-600 mb-4">{t.description}</p>
                  <div className="flex gap-4 text-sm text-gray-500 mb-4"><span>{t.questions.length} вопросов</span><span>{t.timeLimit} мин</span></div>
                  {best !== null && <div className="mb-4 p-3 bg-blue-50 rounded-lg"><p className="text-sm text-blue-900">Лучший: <span className="font-bold">{best}%</span></p><p className="text-xs text-blue-700">{us.length} попыток</p></div>}
                  <button onClick={() => { setSession({ id: Date.now(), testId: t.id, userId: user.id, startedAt: new Date().toISOString(), status: 'in-progress' }); setAnswers({}); setQIndex(0); setTime(t.timeLimit * 60); setView('taking'); }} className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 font-semibold"><Play className="w-5 h-5" />Начать</button>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );

  if (view === 'taking') {
    const test = tests.find(t => t.id === session.testId);
    const q = test.questions[qIndex];
    const prog = ((qIndex + 1) / test.questions.length) * 100;
    return (
      <div className="min-h-screen bg-gray-50">
        <nav className="bg-white shadow-sm border-b"><div className="max-w-7xl mx-auto px-4 py-4"><div className="flex justify-between mb-2"><h1 className="text-xl font-bold">{test.title}</h1><div className="flex items-center gap-2 text-lg font-bold text-red-600"><Clock className="w-5 h-5" />{Math.floor(time / 60)}:{(time % 60).toString().padStart(2, '0')}</div></div><div className="w-full bg-gray-200 rounded-